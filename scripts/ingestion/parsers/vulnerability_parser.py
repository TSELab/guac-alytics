#!/usr/bin/env python
import requests
import sqlite3
from vulnerability_main import insert_records
from constants import DB_LOC, VULNERABILITY_DATA

# Define the main parser function
def parser():
    con = sqlite3.connect(DB_LOC)
    # Check if the file exists locally, if not, download it
    response = requests.get(VULNERABILITY_DATA)

        # Parse the data as JSON
    parsed_data = response.json()

    for name, vulnerability in parsed_data.items():
        for cve, info in vulnerability.items():
            if 'description' in info:
                description = info['description']
            else:
                description="None"
            if 'debianbug' in info:
                debianbug = info['debianbug']
            else:
                debianbug="None"
            if 'scope' in info:
                scope = info['scope']
            else:
                scope="None"
            releases = info['releases']
            # print(f"{name}|{cve}|{description}|{debianbug}|{scope}|{releases}")
            cur = con.cursor()
            # to insert records into the table
            insert_records(cur,name,cve,description,debianbug,scope,releases) 
            con.commit()
    con.close()

if __name__ == "__main__":
    parser()
